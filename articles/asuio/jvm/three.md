# 类文件结构
## Class类文件结构
- Class文件是一组以8字节为基础单位的二进制流，各个数据项目严格按照数据紧凑的排列在Class文件之中，中间没有添加任何分隔符，这使得整个Class文件中存储的内容几乎都是程序运行的必要数据。当遇到需要占用8个字节以上空间的的数据项时，则会按照高位在前的方式分割成若干个8位字节进行存储。
- Class文件格式采用一种类似于C语言结构体的伪结构来存储，这种伪结构中只有两种数据类型：无符号数和表
- 无符号数：是基本的数据类型，以u1、u2、u4、u8来分别表示1个字节，2个字节，4个自己和8个字节，无符号数用来描述数字、索引引用、数量值、或者按照UTF-8编码构成的字符串值。
- 表：是由多个无符号数或其他表作为数据项构成的符合数据类型，所有表习惯性地以_info结尾。表是用于描述有层次关系的符合结构的数据，整个1Class文件本质上就是一张表。
#### 魔数与Class文件的版本
  - 每个Class文件的头4个字节称为魔数，它的唯一作用是用于确定这个文件是否是一个能被虚拟机接收的Class文件。
  - 紧接着魔数的4个自己存储的是Class文件的版本号：第5个和第6个是次版本号（Minor Version），第7个和第8个字节是主版本号（Major Version）

  > Java7的环境运行Java8的代码时常常会抛一个异常，java.lang.UnsupportedClassVersionError:com/sun/tools/javac/Main : Unsupported major.minor version 52.0，便是Major Version超出虚拟机支持的范围

#### 常量池
- 常量池入口紧跟在主次版号之后。
- 常量池中常量的数量是不固定的，所以在常量池的入口需要放置一项u2类型的数据，代表常量池容量计数。这个计数器的初始值是1，而不是0。
- 常量池中主要存放两大类常量：字面量和符号引用。字面量比较接近于Java语言层面的常量概念。而符号引用自属于编译原理方面的概念，包含了三个方面:
  - 类和接口的全限定名
  - 字段的名称和描述符
  - 方法的名称和描述符
- 常量池中每一项常量都是一个表，共有11种结构各不相同的表结构数据，每个表开始的第一位是一个u1类型的标志位。  

Java代码在进行Javac编译的时候，并不像C和C++那样有“连接”这一步骤，而是在虚拟机加载Class文件的时候进行动态连接。也就是说，在Class文件中不会保存各个方法、字段的最终内存布局信息，因此这些字段、方法的符号引用不经过运行周期转换的话无法得到真正的内存入口地址，也就无法直接被虚拟机使用。当虚拟机运行时，需要从常量池获得对应的符号引用，再在类创建时或运行时解析、翻译到具体的内存地址中。  
常量池中每一项常量都是一个表。

<div align='center'> <img src='/img/asuio/const-table-struct.png' alt="test"></div>

上面图中，每一种表都有一个共同的特点，就是表开始的第一位是一个u1类型的标志位，表示当前常量属于那种常量类型。
:::tip
常量池中每一项常量都是一个表，共有14种结构各不相同的表结构数据，每个表开始的第一位是一个u1类型的标志位。  
:::

<div align='center'> <img src='/img/asuio/const-item-type-struct.png' alt="test"></div>

上图展示了常量池中每种类型的数据结构。

#### 访问标志
在常量池结束后，紧接着的两个字节代表访问标志（access_flag），这个标志用于识别一些类或者接口层次的访问信息。包括：这个Class是类还是接口；是否定义为public，是否为abstract类型。如果是类的话，是否被声明为final等。

<div align='center'> <img src='/img/asuio/access-flag-table.png' alt="test"></div>

上图中，由于有不能同时存在的访问标志，所以在对访问标志的储存上，对几个访问标志进行或操作即可。

#### 类索引、父类索引与接口索引集合
类索引和父类索引都是一个u2类型的数据，而接口索引集合是一组u2类型的数据的集合，Class文件中由这三项数据来确定这个类的集成关系。类索引确定该类的全限定名，父类索引确定这个类的父类的全限定名。由于Java不允许多继承，所以出java.lang.Object类外，其他所有类的父索引都不为0。接口索引集合就用来描述这个类实现了哪些接口，这个被实现的接口将按implements语句后的接口顺序从左到右排列在接口索引集合中。   
类索引和父类索引用两个u2类型的索引值表示，它们各自指向常量池中一个类型为CONSTANT_Class_info的类描述常量，通过CONSTANT_Class_info类型的常量中的索引值找到定义在CONSTANT_Utf8_info类型的常量中的全限定名称字符串。

#### 字段表集合
字段表用于描述接口或者类中声明的变量。  
字段表中包括的信息有：字段的作用域（public、private、protected）、是实例变量还是类变量（static修饰符）、可变性（final）、并发可见性（volatile）、可否被序列化（transient）、字段数据类型（基本类型、对象、数组）、字段名称。   
字段修饰符放在access_flags中，它与类中的access_flags项目非常的相似，都是u2的数据类型。
<div align='center'> <img src='/img/asuio/field-info-access.png' alt="test"></div>
跟随着access_flags标志的两项索引值：name_index和descriptor_index。它们都是对常量池的引用，分别代表着字段的简单名称以及字段和方法的描述符。
```Java
package org.asuio.clazz;
public class Test{
    private int a = 0;
    public void inc(){
        a += 1;
    }
}
```
- 全限定名：在上面的代码中，全限定名称为“org/asuio/clazz/Test;”.
- 简单名称：指的是没有类型和参数修饰的方法或者字段名称，这个类中的a字段和方法inc()的简单名称分别是“a”和“inc”。
- 描述符：描述符的作用是用来描述字段类型、方法的参数类别（包括数量、顺序以及顺序）和返回值。基本数据类型和代表无返回值的void类型都用一个大写字母表示。对象类型用L加对象那个的全限定名表示。
<div align='center'> <img src='/img/asuio/desc-type.png' alt="test"></div>
  对于数组类型来说，每一个维度将使用一个前置的"["字符来描述。   
  用描述符描述方法的时候，按照先参数列表后返回值的顺序描述，参数列表按照参数的严格顺序放在一组小括号"()"内，如上面所示的空方法inc()的描述符为“()V”。
#### 方法表集合
方法表的结构如同字段表一样，依次包括了访问标志（access_flags）、名称索引（name_index）、描述符索引（descriptor_index）、属性表集合（attributes）几项。

#### 属性表集合
- 未完待续
